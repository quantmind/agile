{% if item.websocket | default(False) %}
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}
{% endif %}

{% include "ssl.redirect.conf.j2" with context %}

server {
{% if item.certificate | default(False) %}
{% include "https.conf.j2" with context %}
{% else %}
{% include "http.conf.j2" with context %}
{% endif %}

    server_name {{ item.domain }};

    client_body_in_file_only clean;
    client_body_buffer_size 32K;
    client_max_body_size 300M;
    sendfile on;
    send_timeout 300s;

    proxy_http_version 1.1;

{% if acme_challenge_path | default(False) %}
{% include "acme-challenge.conf.j2" with context %}
{% endif %}

{% if item.host | default(False) %}
{% include "proxypass.conf.j2" with context %}
{% elif item.s3location | default(False) %}
{% include "aws.conf.j2" with context %}
{% endif %}

}
